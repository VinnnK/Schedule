<!-- index.html -->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>모임 시간표</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 1rem;
        max-width: 800px;
        margin: auto;
      }
      input, button, select {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 1rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .actions button {
        width: auto;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 1rem;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: center;
      }
      td.hour-cell {
        cursor: pointer;
        background-color: #f0f0f0;
      }
      td.selected-current {
        background-color: #22c55e !important;
        color: white !important;
      }
      td[data-count="1"]:not(.selected-current) { background-color: #dbeafe; }
      td[data-count="2"]:not(.selected-current) { background-color: #bfdbfe; }
      td[data-count="3"]:not(.selected-current) { background-color: #93c5fd; }
      td[data-count="4"]:not(.selected-current) { background-color: #60a5fa; color: white; }
      td[data-count="5"]:not(.selected-current) { background-color: #3b82f6; color: white; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>모임 시간표</h1>
      <div class="actions">
        <button onclick="selectAllHours()">전체 선택</button>
        <button onclick="clearAllHours()">전체 취소</button>
      </div>
    </div>
    <input type="text" id="nickname" placeholder="닉네임을 입력하세요" />
    <table>
      <thead>
        <tr><th>시간</th><th>참여 인원</th></tr>
      </thead>
      <tbody id="time-table"></tbody>
    </table>
    <button onclick="saveSchedule()">시간 저장하기</button>
    <button onclick="deleteSchedule()">입력 삭제하기</button>

    <script>
      // 🔹 Firebase 설정 (복사한 내용 붙여넣기)
      const firebaseConfig = {
        apiKey: "AIzaSyA-U74_QfN7CanKwDOpyM97KYN7Jromiy4",
        authDomain: "schedule-da078.firebaseapp.com",
        projectId: "schedule-da078",
        storageBucket: "schedule-da078.appspot.com",
        messagingSenderId: "480800174812",
        appId: "1:480800174812:web:4b11969665249be810fa19"
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      const HOURS = [...Array(24).keys()].map(i => (i + 7) % 24);
      let schedule = {};
      let currentUserSchedule = [];

      const table = document.getElementById("time-table");

      function renderTable() {
        table.innerHTML = "";
        HOURS.forEach((hour) => {
          const tr = document.createElement("tr");
          const th = document.createElement("th");
          th.textContent = `${hour}:00`;

          const td = document.createElement("td");
          const participants = getHourParticipants(hour);
          td.className = "hour-cell";
          td.dataset.count = participants.length;
          td.innerText = participants.length;

          if (currentUserSchedule.includes(hour)) {
            td.classList.add("selected-current");
          }
          td.title = participants.join(", ");
          td.onclick = () => toggleHour(hour);

          tr.appendChild(th);
          tr.appendChild(td);
          table.appendChild(tr);
        });
      }

      function toggleHour(hour) {
        if (currentUserSchedule.includes(hour)) {
          currentUserSchedule = currentUserSchedule.filter(h => h !== hour);
        } else {
          currentUserSchedule.push(hour);
        }
        renderTable();
      }

      function getHourParticipants(hour) {
        return Object.entries(schedule)
          .filter(([_, hours]) => hours.includes(hour))
          .map(([name]) => name);
      }

      function saveSchedule() {
        const name = document.getElementById("nickname").value.trim();
        if (!name) return alert("닉네임을 입력하세요.");
        if (currentUserSchedule.length === 0) return alert("시간을 선택하세요.");

        db.collection("schedules").doc(name).set({ hours: currentUserSchedule })
          .then(() => {
            alert("저장되었습니다!");
            currentUserSchedule = [];
            loadSchedules();
          });
      }

      function deleteSchedule() {
        const name = document.getElementById("nickname").value.trim();
        if (!name) return alert("닉네임을 입력하세요.");

        db.collection("schedules").doc(name).delete()
          .then(() => {
            alert("삭제되었습니다!");
            currentUserSchedule = [];
            loadSchedules();
          });
      }

      function selectAllHours() {
        currentUserSchedule = [...HOURS];
        renderTable();
      }

      function clearAllHours() {
        currentUserSchedule = [];
        renderTable();
      }

      function loadSchedules() {
        db.collection("schedules").get().then(snapshot => {
          schedule = {};
          snapshot.forEach(doc => {
            schedule[doc.id] = doc.data().hours;
          });
          renderTable();
        });
      }

      loadSchedules();
    </script>
  </body>
</html>
